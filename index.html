<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon" />
  <title>Pencatat Keuangan</title>

  <!-- ========== All CSS files linkup ========= -->
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/lineicons.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="assets/css/materialdesignicons.min.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="assets/css/fullcalendar.css" />
  <link rel="stylesheet" href="assets/css/fullcalendar.css" />
  <link rel="stylesheet" href="assets/css/main.css" />
</head>

<body>
  <!-- ======== Preloader =========== -->
  <div id="preloader">
    <div class="spinner"></div>
  </div>
  <!-- ======== Preloader =========== -->

  <!-- ======== sidebar-nav start =========== -->
  <aside class="sidebar-nav-wrapper" id="sidebar-area"></aside>
  <div class="overlay"></div>
  <!-- ======== sidebar-nav end =========== -->

  <!-- ======== main-wrapper start =========== -->
  <main class="main-wrapper">
    <!-- ========== header start ========== -->
  <header class="header" id="header-area"></header>
    <!-- ========== header end ========== -->

    <!-- ========== section start ========== -->
    <section class="section">
      <!-- ========== title-wrapper start ========== -->
      <div class="container-fluid">
        <div class="title-wrapper pt-30">
          <div class="row align-items-center">
            <div class="col-md-6">
              <div class="title">
                <h2>Dashboard Keuangan</h2>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-xl-3 col-lg-4 col-sm-6">
            <div class="icon-card mb-30">
              <div class="icon primary">
                <i class="lni lni-wallet"></i>
              </div>
              <div class="content">
                <h6 class="mb-10">Total Saldo</h6>
                <h3 class="text-bold mb-10" id="totalSaldo">Rp 0</h3>
                <p class="text-sm text-success">
                  <span class="text-gray">Update: Hari ini</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-lg-4 col-sm-6">
            <div class="icon-card mb-30">
              <div class="icon success">
                <i class="lni lni-arrow-up"></i>
              </div>
              <div class="content">
                <h6 class="mb-10">Pemasukan (Total)</h6>
                <h3 class="text-bold mb-10" id="totalIncome">Rp 0</h3>
                <p class="text-sm text-success">
                  <i class="lni lni-arrow-up"></i> +5.45%
                  <span class="text-gray">vs bulan lalu</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-lg-4 col-sm-6">
            <div class="icon-card mb-30">
              <div class="icon orange">
                <i class="lni lni-arrow-down"></i>
              </div>
              <div class="content">
                <h6 class="mb-10">Pengeluaran (Total)</h6>
                <h3 class="text-bold mb-10" id="totalExpense">Rp 0</h3>
                <p class="text-sm text-danger">
                  <i class="lni lni-arrow-up"></i> +2.00%
                  <span class="text-gray">vs bulan lalu</span>
                </p>
              </div>
            </div>
          </div>
          <div class="col-xl-3 col-lg-4 col-sm-6">
            <div class="icon-card mb-30">
              <div class="icon purple">
                <i class="lni lni-pie-chart"></i>
              </div>
              <div class="content">
                <h6 class="mb-10">Sisa Budget</h6>
                <h3 class="text-bold mb-10">Rp 1.800.000</h3>
                <p class="text-sm text-success">
                  <span class="text-gray">Aman</span>
                </p>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-7">
            <div class="card-style mb-30">
              <div class="title d-flex flex-wrap justify-content-between">
                <div class="left">
                  <!-- <h6 class="text-medium mb-10">Arus Kas </h6> -->
                  <h2 class="text-bold" id="chart1Summary">Arus Kas</h2>
                </div>
                <div class="right">
                  <div class="select-style-1">
                    <div class="select-position select-sm">
                      <select class="light-bg" id="periodSelect1" onchange="updateChart1(this.value)">
                        <option value="weekly">Mingguan</option>
                        <option value="monthly" selected>Bulanan</option>
                        <option value="yearly">Tahunan</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="chart">
                <canvas id="Chart1" style="width: 100%; height: 400px; margin-left: 0;"></canvas>
              </div>
            </div>
          </div>
          <div class="col-lg-5">
            <div class="card-style mb-30">
              <div class="title d-flex flex-wrap align-items-center justify-content-between">
                <div class="left">
                  <h6 class="text-medium mb-30">Pengeluaran per Kategori</h6>
                </div>
                <div class="right">
                  <div class="select-style-1">
                    <div class="select-position select-sm">
                      <select class="light-bg" id="periodSelect2" onchange="updateChart2(this.value)">
                        <option value="weekly">Mingguan</option>
                        <option value="monthly" selected>Bulanan</option>
                        <option value="yearly">Tahunan</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="chart">
                <canvas id="Chart2" style="width: 100%; height: 400px; margin-left: 0;"></canvas>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <div class="card-style mb-30">
                <div class="title d-flex flex-wrap align-items-center justify-content-between">
                  <div class="left">
                    <h6 class="text-medium mb-30">Riwayat Transaksi Terakhir</h6>
                  </div>
                  <div class="right">
                    <a href="transaksi.html" class="main-btn primary-btn btn-hover btn-sm">Lihat Semua</a>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table top-selling-table">
                    <thead>
                      <tr>
                        <th>
                          <h6 class="text-sm text-medium">Tanggal</h6>
                        </th>
                        <th class="min-width">
                          <h6 class="text-sm text-medium">Kategori</h6>
                        </th>
                        <th class="min-width">
                          <h6 class="text-sm text-medium">Deskripsi</h6>
                        </th>
                        <th class="min-width">
                          <h6 class="text-sm text-medium">Nominal</h6>
                        </th>
                        <th class="min-width">
                          <h6 class="text-sm text-medium">Tipe</h6>
                        </th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody id="recentTransactions">
                      <tr>
                        <td>
                          <p class="text-sm">20 Des 2025</p>
                        </td>
                        <td>
                          <p class="text-sm">Makan & Minum</p>
                        </td>
                        <td>
                          <p class="text-sm">Makan Siang</p>
                        </td>
                        <td>
                          <p class="text-sm">Rp 45.000</p>
                        </td>
                        <td><span class="status-btn close-btn">Keluar</span></td>
                        <td>
                          <div class="action justify-content-end">
                            <button class="edit"><i class="lni lni-pencil"></i></button>
                            <button class="text-danger ml-10"><i class="lni lni-trash-can"></i></button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <p class="text-sm">19 Des 2025</p>
                        </td>
                        <td>
                          <p class="text-sm">Gaji</p>
                        </td>
                        <td>
                          <p class="text-sm">Gaji Bulanan</p>
                        </td>
                        <td>
                          <p class="text-sm">Rp 8.000.000</p>
                        </td>
                        <td><span class="status-btn success-btn">Masuk</span></td>
                        <td>
                          <div class="action justify-content-end">
                            <button class="edit"><i class="lni lni-pencil"></i></button>
                            <button class="text-danger ml-10"><i class="lni lni-trash-can"></i></button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <p class="text-sm">18 Des 2025</p>
                        </td>
                        <td>
                          <p class="text-sm">Transportasi</p>
                        </td>
                        <td>
                          <p class="text-sm">Bensin Motor</p>
                        </td>
                        <td>
                          <p class="text-sm">Rp 30.000</p>
                        </td>
                        <td><span class="status-btn close-btn">Keluar</span></td>
                        <td>
                          <div class="action justify-content-end">
                            <button class="edit"><i class="lni lni-pencil"></i></button>
                            <button class="text-danger ml-10"><i class="lni lni-trash-can"></i></button>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- end container -->
    </section>
    <!-- ========== section end ========== -->

    <!-- ========== footer start =========== -->
    <footer class="footer" id="footer-area"></footer>
    <!-- ========== footer end =========== -->
  </main>
  <!-- ======== main-wrapper end =========== -->

  <!-- ========= All Javascript files linkup ======== -->
 <script src="assets/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/Chart.min.js"></script>
<script src="assets/js/dynamic-pie-chart.js"></script>
<script src="assets/js/moment.min.js"></script>
<script src="assets/js/fullcalendar.js"></script>
<script src="assets/js/jvectormap.min.js"></script>
<script src="assets/js/world-merc.js"></script>
<script src="assets/js/polyfill.js"></script>
<script src="assets/js/main.js"></script>

<script src="api.js"></script>
<script src="layout.js"></script> 

<script>
    // 1. CEK OTENTIKASI
    checkAuth(); // Dari api.js

    // Helper: Format Rupiah
    const formatRupiah = (number) => {
        return new Intl.NumberFormat('id-ID', { 
            style: 'currency', 
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(number);
    };

    // Helper: Format Tanggal
    const formatDate = (dateString) => {
        const options = { day: 'numeric', month: 'short', year: 'numeric' };
        return new Date(dateString).toLocaleDateString('id-ID', options);
    };

    // ================= MAIN LOGIC =================
    document.addEventListener("DOMContentLoaded", async function () {
        
        try {
            // Fetch Data Income & Expense (Paralel biar cepat)
            const [resIncome, resExpense] = await Promise.all([
                fetch(`${API_BASE_URL}/income-batches`, { headers: getAuthHeaders() }),
                fetch(`${API_BASE_URL}/expense-batches`, { headers: getAuthHeaders() })
            ]);

            const rawIncomes = await resIncome.json();
            const rawExpenses = await resExpense.json();

            // Normalisasi data (API kadang return object pembungkus)
            const incomes = rawIncomes.data || rawIncomes;
            const expenses = rawExpenses.data || rawExpenses;

            // --- 1. HITUNG TOTAL KARTU ---
            const totalInc = incomes.reduce((sum, item) => sum + parseInt(item.total), 0);
            const totalExp = expenses.reduce((sum, item) => sum + parseInt(item.total), 0);
            const saldo = totalInc - totalExp;

            document.getElementById('totalIncome').innerText = formatRupiah(totalInc);
            document.getElementById('totalExpense').innerText = formatRupiah(totalExp);
            document.getElementById('totalSaldo').innerText = formatRupiah(saldo);

            // --- 2. UPDATE TABEL TRANSAKSI TERAKHIR ---
            const allTrans = [
                ...incomes.map(i => ({...i, type: 'Masuk', class: 'success-btn', nominal: i.total})),
                ...expenses.map(i => ({...i, type: 'Keluar', class: 'close-btn', nominal: i.total}))
            ];

            // Sort berdasarkan tanggal terbaru (descending) & ambil 5 teratas
            // Asumsi API punya field 'createdAt' atau 'date', sesuaikan jika beda
            allTrans.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
            const recentTrans = allTrans.slice(0, 5);

            const tableBody = document.getElementById('recentTransactions');
            tableBody.innerHTML = ''; // Reset

            recentTrans.forEach(item => {
                tableBody.innerHTML += `
                    <tr>
                        <td><p class="text-sm">${formatDate(item.createdAt || item.date || new Date())}</p></td>
                        <td><p class="text-sm">${item.description || '-'}</p></td>
                        <td><p class="text-sm">${item.description}</p></td>
                        <td><p class="text-sm">${formatRupiah(item.nominal)}</p></td>
                        <td><span class="status-btn ${item.class}">${item.type}</span></td>
                        <td>
                            <div class="action justify-content-end">
                                <button class="text-danger"><i class="lni lni-trash-can"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            // --- 3. PREPARE CHART DATA (Bulanan Tahun Ini) ---
            const currentYear = new Date().getFullYear();
            const incomePerMonth = new Array(12).fill(0);
            const expensePerMonth = new Array(12).fill(0);

            incomes.forEach(item => {
                const d = new Date(item.createdAt || item.date); // Cek field tanggal API
                if(d.getFullYear() === currentYear) incomePerMonth[d.getMonth()] += parseInt(item.total);
            });

            expenses.forEach(item => {
                const d = new Date(item.createdAt || item.date);
                if(d.getFullYear() === currentYear) expensePerMonth[d.getMonth()] += parseInt(item.total);
            });

            // --- 4. RENDER CHART 1 (Arus Kas) ---
            const ctx1 = document.getElementById("Chart1").getContext("2d");
            new Chart(ctx1, {
                type: "line",
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"],
                    datasets: [
                        {
                            label: "Pemasukan",
                            borderColor: "#365CF5",
                            backgroundColor: "transparent",
                            data: incomePerMonth,
                            tension: 0.4,
                            borderWidth: 3
                        },
                        {
                            label: "Pengeluaran",
                            borderColor: "#d50100",
                            backgroundColor: "transparent",
                            data: expensePerMonth,
                            tension: 0.4,
                            borderWidth: 3
                        }
                    ],
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { beginAtZero: true, grid: { display: true, drawBorder: false } },
                        x: { grid: { display: false } }
                    }
                },
            });

            // --- 5. RENDER CHART 2 (Dummy for now / Expense Categories) ---
            // Karena endpoint API kategori terpisah, kita pakai data expensePerMonth dulu sebagai visualisasi
            const ctx2 = document.getElementById("Chart2").getContext("2d");
            new Chart(ctx2, {
                type: "bar",
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun"],
                    datasets: [{
                        label: "Pengeluaran",
                        backgroundColor: "#365CF5",
                        borderRadius: 5,
                        data: expensePerMonth.slice(0, 6) // Ambil 6 bulan pertama
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });

        } catch (error) {
            console.error("Error Dashboard:", error);
            // Jangan alert error terus-terusan di dashboard, cukup console.log
        }
    });
</script>
</body>

</html>