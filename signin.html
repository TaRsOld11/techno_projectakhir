<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign In | Aplikasi Keuangan</title>
    <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="assets/css/lineicons.css" />
    <link rel="stylesheet" href="assets/css/materialdesignicons.min.css" />
    <link rel="stylesheet" href="assets/css/main.css" />
  </head>
  <body>
    <div id="preloader">
      <div class="spinner"></div>
    </div>

    <main class="content-wrapper">
      <div class="row g-0 auth-row">
        <div class="col-lg-6">
          <div class="auth-cover-wrapper bg-primary-100">
            <div class="auth-cover">
              <div class="title text-center">
                <h1 class="text-primary mb-10">Selamat Datang Kembali</h1>
                <p class="text-medium">
                  Silakan masuk untuk melanjutkan pencatatan keuangan.
                </p>
              </div>
              <div class="cover-image">
                <img src="assets/images/auth/signin-image.svg" alt="" />
              </div>
              <div class="shape-image">
                <img src="assets/images/auth/shape.svg" alt="" />
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-lg-6">
          <div class="signin-wrapper">
            <div class="form-wrapper">
              <h6 class="mb-15">Form Login</h6>
              <p class="text-sm mb-25">
                Masukkan kredensial akun Anda.
              </p>
              
              <form id="loginForm">
                <div class="row">
                  <div class="col-12">
                    <div class="input-style-1">
                      <label>Email / Username</label>
                      <input type="text" id="email" placeholder="Masukkan email atau username" required />
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="input-style-1">
                      <label>Password</label>
                      <input type="password" id="password" placeholder="Password" required />
                    </div>
                  </div>
                  <div class="col-xxl-6 col-lg-12 col-md-6">
                    <div class="form-check checkbox-style mb-30">
                      <input class="form-check-input" type="checkbox" value="" id="checkbox-remember" />
                      <label class="form-check-label" for="checkbox-remember">
                        Ingat Saya
                      </label>
                    </div>
                  </div>
                  <div class="col-xxl-6 col-lg-12 col-md-6">
                    <div class="text-start text-md-end text-lg-start text-xxl-end mb-30">
                      <a href="#0" class="hover-underline">Lupa Password?</a>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="button-group d-flex justify-content-center flex-wrap">
                      <button type="submit" class="main-btn primary-btn btn-hover w-100 text-center">
                        Sign In
                      </button>
                    </div>
                  </div>
                </div>
              </form>
              
              <div class="singin-option pt-40">
                <p class="text-sm text-medium text-center text-gray">
                  Belum punya akun? <a href="signup.html">Buat Akun</a>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/main.js"></script>
    
    <script src="api.js"></script> 
    <script>
      document.getElementById('loginForm').addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // Ambil nilai input
          const emailOrUsername = document.getElementById('email').value;
          const password = document.getElementById('password').value;
          const btn = e.target.querySelector('button');

          // Ubah tombol jadi Loading...
          const originalText = btn.innerText;
          btn.innerText = "Masuk...";
          btn.disabled = true;

          try {
              const response = await fetch(`${API_BASE_URL}/auth/login`, {
                  method: 'POST',
                  // Header pakai yang Public (cuma butuh API Key)
                  headers: getPublicHeaders(), 
                  // PENTING: Key diganti jadi 'identifier' sesuai gambar API
                  body: JSON.stringify({ 
                      identifier: emailOrUsername, 
                      password: password 
                  })
              });

              const result = await response.json();

              if (response.ok) {
                  // Simpan token (biasanya di properti result.data.token atau result.token)
                  // Kita jaga-jaga cek dua kemungkinan struktur response
                  const token = result.token || (result.data && result.data.token) || result.accessToken;

                  const user = result.user || (result.data && result.data.user) || result.data || {};
                  
                  if (token) {
                      localStorage.setItem('token', token);
                      localStorage.setItem('user_profile', JSON.stringify(user));
                      alert("✅ Login Berhasil! Halo, " + (user.username || "User"));
                      window.location.href = 'index.html';
                  } else {
                      alert("⚠️ Login sukses tapi token tidak ditemukan.");
                      console.log("Full Result:", result);
                  }
              } else {
                  // Tampilkan pesan error dari server
                  const msg = result.message || (result.error ? result.error.message : "Login Gagal");
                  alert("❌ Gagal: " + msg);
              }
          } catch (error) {
              console.error(error);
              alert("❌ Gagal terhubung ke server.");
          } finally {
              btn.innerText = originalText;
              btn.disabled = false;
          }
      });
    </script>
  </body>
</html>