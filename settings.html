<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pengaturan | Aplikasi Keuangan</title>
  <link rel="stylesheet" href="assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="assets/css/lineicons.css" />
  <link rel="stylesheet" href="assets/css/materialdesignicons.min.css" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    .settings-main-card {
      padding: 0;
    }

    .settings-item {
      width: 100%;
      border: none;
      background: transparent;
      padding: 18px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .settings-item:hover {
      background: #f9fafb;
    }

    .settings-item i {
      font-size: 18px;
      color: #6c757d;
    }

    .settings-item.danger h6,
    .settings-item.danger i {
      color: #dc3545;
    }

    .settings-user {
      background: #fafafa;
    }
  </style>
</head>

<body>
  <div id="preloader">
    <div class="spinner"></div>
  </div>

  <aside class="sidebar-nav-wrapper" id="sidebar-area"></aside>
  <div class="overlay"></div>

  <main class="main-wrapper">
    
    <header class="header" id="header-area"></header>

    <section class="section">
      <div class="container-fluid">
        <div class="title-wrapper pt-30 mb-20">
          <h2>Pengaturan Akun</h2>
          <p class="text-sm text-gray">Kelola akun dan preferensi aplikasi Anda</p>
        </div>

        <div class="row justify-content-center">
          <div class="col-lg-6">
            <div class="card-style settings-main-card">

              <!-- Main card -->
              <div class="settings-user text-center p-30">
                <img src="assets/images/profile/profile-image.png" class="rounded-circle mb-10" width="90" alt="User" />
                <h6 class="mb-0" id="headerName">Nama User</h6>
                <p class="text-sm text-gray" id="headerEmail">admin@example.com</p>
              </div>

              <!-- PROFIL -->
              <button class="settings-item" data-bs-toggle="modal" data-bs-target="#modalProfile">
                <div>
                  <h6>Profil Saya</h6>
                  <p class="text-sm text-gray">Lihat dan ubah identitas akun</p>
                </div>
                <i class="lni lni-chevron-right"></i>
              </button>

              <!-- PASSWORD -->
              <button class="settings-item" data-bs-toggle="modal" data-bs-target="#modalPassword">
                <div>
                  <h6>Ganti Password</h6>
                  <p class="text-sm text-gray">Perbarui keamanan akun</p>
                </div>
                <i class="lni lni-lock"></i>
              </button>

              <!-- TARGET KEUANGAN -->
              <button class="settings-item" data-bs-toggle="modal" data-bs-target="#modalBudget">
                <div>
                  <h6>Budgeting</h6>
                  <p class="text-sm text-gray">Atur batas pengeluaran bulanan</p>
                </div>
                <i class="lni lni-wallet"></i>
              </button>

              <!-- KATEGORI -->
              <button class="settings-item" data-bs-toggle="modal" data-bs-target="#modalKategori">
                <div>
                  <h6>Kategori Custom</h6>
                  <p class="text-sm text-gray">Kelola kategori transaksi manual</p>
                </div>
                <i class="lni lni-list"></i>
              </button>

              <hr>

              <!-- HAPUS AKUN -->
              <button class="settings-item danger" data-bs-toggle="modal" data-bs-target="#modalDeleteAccount">
                <div>
                  <h6>Hapus Akun</h6>
                  <p class="text-sm">Akun akan dinonaktifkan secara permanen</p>
                </div>
                <i class="lni lni-warning"></i>
              </button>


              <!-- SIGN OUT -->
              <button class="settings-item danger" data-bs-toggle="modal" data-bs-target="#modalSignout">
                <div>
                  <h6>Sign Out</h6>
                  <p class="text-sm">Keluar dari akun ini</p>
                </div>
                <i class="lni lni-exit"></i>
              </button>


            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal profil -->
    <div class="modal fade" id="modalProfile" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Profil Saya</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <div class="text-center mb-20">
              <img
                id="profileAvatar"
                src="assets/images/profile/profile-image.png"
                class="rounded-circle mb-10"
                width="90"
              >
            </div>

            <div class="input-style-1">
              <label>Nama Lengkap</label>
              <input type="text" id="profileName" disabled>
            </div>

            <div class="input-style-1">
              <label>Email</label>
              <input type="email" id="profileEmail" disabled>
            </div>

            <div class="input-style-1">
              <label>Bio</label>
              <textarea rows="3" id="profileBio" disabled></textarea>
            </div>

            <!-- <button class="main-btn secondary-btn w-100" data-bs-dismiss="modal">
              Tutup
            </button> -->

          </div>
        </div>
      </div>
    </div>



    <!-- Modal ganti password  -->
    <div class="modal fade" id="modalPassword" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Ganti Password</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <div class="input-style-1">
              <label>Password Saat Ini</label>
              <input type="password" id="currentPassword" placeholder="(Opsional)">
            </div>

            <div class="input-style-1">
              <label>Password Baru</label>
              <input type="password" id="newPassword">
            </div>

            <div class="input-style-1">
              <label>Konfirmasi Password</label>
              <input type="password" id="confirmPassword">
            </div>

            <button
              class="main-btn primary-btn btn-hover w-100"
              onclick="changePassword()"
            >
              Update Password
            </button>

          </div>
        </div>
      </div>
    </div>


    <!-- Modal budgeting  -->
    <div class="modal fade" id="modalBudget" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Budgeting</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">

            <div class="input-style-1">
              <label>Batas Bulanan (Rp)</label>
              <input type="text" id="budgetInput" placeholder="Contoh: 5.000.000"/>

              <input type="hidden" id="budgetValue">

            </div>

            <div class="form-check checkbox-style mb-20">
              <input class="form-check-input" type="checkbox" checked>
              <label class="form-check-label">
                Notifikasi saat mencapai 80%
              </label>
            </div>

            <button class="main-btn primary-btn btn-hover w-100" onclick="saveBudget()">
              Simpan Target
            </button>

          </div>
        </div>
      </div>
    </div>


    <!-- Modal kategori custom -->
    <div class="modal fade" id="modalKategori" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">Kategori Custom</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <!-- Pilih tipe -->
            <div class="mb-15">
              <select class="form-select" id="categoryType">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>

            <!-- List kategori -->
            <div class="table-wrapper table-responsive mb-20">
              <table class="table">
                <tbody id="categoryTable">
                  <!-- data dari API masuk di sini -->
                </tbody>
              </table>
            </div>

            <!-- Tambah kategori -->
            <div class="input-style-1 mb-10">
              <label>Nama Kategori</label>
              <input type="text" id="categoryName" placeholder="Contoh: Donasi">
            </div>

            <div class="input-style-1 mb-20">
              <label>Deskripsi</label>
              <input type="text" id="categoryDesc" placeholder="Opsional">
            </div>

            <button class="main-btn primary-btn btn-hover w-100" onclick="addCategory()">
              Tambah Kategori
            </button>

          </div>
        </div>
      </div>
    </div>


    <!-- modal hapus akun -->
    <div class="modal fade" id="modalDeleteAccount" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title text-danger">Konfirmasi Hapus Akun</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body text-center">
            <i class="lni lni-warning text-danger mb-15" style="font-size:40px"></i>

            <p>
              Apakah Anda yakin ingin <strong>menghapus akun ini</strong>?
              <br>
              Seluruh data akan <strong>dinonaktifkan permanen</strong> dan tidak bisa dikembalikan.
            </p>

            <hr>

            <div class="d-flex gap-10">
              <button class="main-btn secondary-btn w-50" data-bs-dismiss="modal">
                Batal
              </button>
              <button class="main-btn danger-btn w-50" onclick="deleteAccount()">
                Ya, Hapus Akun
              </button>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- modal signout -->
    <div class="modal fade" id="modalSignout" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Konfirmasi Sign Out</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body text-center">
            <i class="lni lni-exit mb-15" style="font-size:40px"></i>
            <p>Apakah Anda yakin ingin keluar dari akun ini?</p>
            <hr>
            <div class="d-flex gap-10">
              <button class="main-btn secondary-btn w-50" data-bs-dismiss="modal">
                Batal
              </button>
              <button class="main-btn danger-btn w-50" onclick="logout()">
                Sign Out
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>


    <footer class="footer" id="footer-area"></footer>
  </main>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="api.js"></script>
  <script src="layout.js"></script>

  <script>
    checkAuth();
  </script>

  <script>
  /* =============================
    PROFIL USER
  ============================= */

  document.addEventListener("DOMContentLoaded", loadProfile);

  function loadProfile() {
    const user = JSON.parse(localStorage.getItem("user_profile"));
    if (!user) return;

    document.getElementById("profileName").value =
      user.fullName || "-";

    document.getElementById("profileEmail").value =
      user.email || "-";

    document.getElementById("profileBio").value =
      user.username ? `Username: ${user.username}` : "-";

    document.getElementById("headerName").innerText =
      user.fullName || user.username || "-";

    document.getElementById("headerEmail").innerText =
      user.email || "-";
  }

  document
    .getElementById("modalProfile")
    .addEventListener("shown.bs.modal", loadProfile);
  </script>

  <script>
  /* =============================
    KATEGORI CUSTOM
  ============================= */

  const categoryTable = document.getElementById("categoryTable");
  const categoryType  = document.getElementById("categoryType");

  categoryType.addEventListener("change", loadCategories);

  function getCategoryEndpoint() {
    return categoryType.value === "income"
      ? "/income-categories"
      : "/expense-categories";
  }

  async function loadCategories() {
    categoryTable.innerHTML = `
      <tr>
        <td class="text-center text-gray">Memuat data...</td>
      </tr>`;

    try {
      const endpoint = getCategoryEndpoint();
      const res = await fetch(API_BASE_URL + endpoint, {
        headers: getAuthHeaders()
      });

      const json = await res.json();
      const data = json.data || [];

      if (data.length === 0) {
        categoryTable.innerHTML = `
          <tr>
            <td class="text-center text-gray">Belum ada kategori</td>
          </tr>`;
        return;
      }

      const typeLabel = endpoint.includes("income")
        ? "Income"
        : "Expense";

      categoryTable.innerHTML = data.map(cat => `
        <tr>
          <td>
            ${cat.name}
            <span class="category-type">(${typeLabel})</span>
          </td>
          <td class="action justify-content-end">
            <button class="text-danger" onclick="deleteCategory('${cat.id}')">
              <i class="lni lni-trash-can"></i>
            </button>
          </td>
        </tr>
      `).join("");

    } catch (err) {
      console.error(err);
      alert("Gagal memuat kategori");
    }
  }

  async function addCategory() {
    const name = categoryName.value.trim();
    const description = categoryDesc.value.trim();

    if (!name) {
      alert("Nama kategori wajib diisi");
      return;
    }

    try {
      const res = await fetch(
        API_BASE_URL + getCategoryEndpoint(),
        {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({ name, description })
        }
      );

      const json = await res.json();
      if (!json.success) {
        alert(json.message || "Gagal menambah kategori");
        return;
      }

      categoryName.value = "";
      categoryDesc.value = "";
      loadCategories();

    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan");
    }
  }

  async function deleteCategory(id) {
    if (!confirm("Yakin ingin menghapus kategori ini?")) return;

    try {
      const res = await fetch(
        API_BASE_URL + getCategoryEndpoint() + `/${id}`,
        {
          method: "DELETE",
          headers: getAuthHeaders()
        }
      );

      const json = await res.json();
      if (!json.success) {
        alert(json.message || "Gagal menghapus");
        return;
      }

      loadCategories();
    } catch (err) {
      console.error(err);
      alert("Gagal menghapus kategori");
    }
  }

  document
    .getElementById("modalKategori")
    .addEventListener("shown.bs.modal", loadCategories);
  </script>

  <script>
  /* =============================
    BUDGETING
  ============================= */

  const budgetInput = document.getElementById("budgetInput");
  const budgetValue = document.getElementById("budgetValue");

  function formatRupiah(angka) {
    return angka
      .toString()
      .replace(/\D/g, "")
      .replace(/\B(?=(\d{3})+(?!\d))/g, ".");
  }

  budgetInput.addEventListener("input", e => {
    const raw = e.target.value.replace(/\D/g, "");
    budgetValue.value = raw;
    e.target.value = raw ? formatRupiah(raw) : "";
  });

  async function loadBudget() {
    try {
      const res = await fetch(API_BASE_URL + "/auth/budget", {
        headers: getAuthHeaders()
      });

      const json = await res.json();
      if (!json.success) return;

      const amount = json.data?.budget || 0;
      budgetValue.value = amount;
      budgetInput.value = formatRupiah(amount);

    } catch (err) {
      console.error("Gagal load budget:", err);
    }
  }

  async function saveBudget() {
    const amount = parseInt(budgetValue.value);

    if (!amount || amount <= 0) {
      alert("Nominal budget wajib diisi dan > 0");
      return;
    }

    try {
      const res = await fetch(API_BASE_URL + "/auth/budget", {
        method: "PUT",
        headers: getAuthHeaders(),
        body: JSON.stringify({ amount })
      });

      const json = await res.json();
      if (!json.success) {
        alert(json.message || "Gagal menyimpan budget");
        return;
      }

      alert("Budget berhasil disimpan");
      bootstrap.Modal
        .getInstance(document.getElementById("modalBudget"))
        .hide();

    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan");
    }
  }

  document
    .getElementById("modalBudget")
    .addEventListener("shown.bs.modal", loadBudget);
  </script>

  <script>
  /* =============================
    GANTI PASSWORD
  ============================= */

  async function changePassword() {
    const newPassword = newPassword.value.trim();
    const confirm     = confirmPassword.value.trim();

    if (!newPassword || !confirm) {
      alert("Password baru dan konfirmasi wajib diisi");
      return;
    }

    if (newPassword.length < 8) {
      alert("Password minimal 8 karakter");
      return;
    }

    if (newPassword !== confirm) {
      alert("Konfirmasi password tidak cocok");
      return;
    }

    try {
      const res = await fetch(API_BASE_URL + "/auth/new-password", {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({ newPassword })
      });

      const json = await res.json();
      if (!json.success) {
        alert(json.message || "Gagal mengubah password");
        return;
      }

      alert("Password berhasil diubah, silakan login ulang");
      localStorage.clear();
      window.location.href = "signin.html";

    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan");
    }
  }
  </script>

  <script>
  /* =============================
    AKUN (HAPUS & LOGOUT)
  ============================= */

  async function deleteAccount() {
    if (!confirm("Tindakan ini permanen. Lanjutkan hapus akun?")) return;

    try {
      const res = await fetch(API_BASE_URL + "/auth/me", {
        method: "DELETE",
        headers: getAuthHeaders()
      });

      const json = await res.json();
      if (!json.success) {
        alert(json.message || "Gagal menghapus akun");
        return;
      }

      alert("Akun berhasil dihapus");
      localStorage.clear();
      window.location.href = "signin.html";

    } catch (err) {
      console.error(err);
      alert("Terjadi kesalahan");
    }
  }

  function logout() {
    if (!confirm("Yakin ingin keluar aplikasi?")) return;
    localStorage.clear();
    window.location.href = "signin.html";
  }
  </script>

</body>

</html>